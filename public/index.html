<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kratos Publisher ‚Äî Christian Book Publishing Course</title>
<meta name="description" content="From Calling to Published Author. A comprehensive 18-lesson course for Christian writers by Kratos Publisher.">
<meta name="theme-color" content="#0A0A0B">
<link rel="icon" type="image/jpeg" href="/images/logo.jpg">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ===========================
   KRATOS PUBLISHER DESIGN SYSTEM
   Colors from logo: Orange #FF8C00, Yellow #FFD700, 
   Cyan #00D4FF, Red #FF1744, Blue #2979FF, Magenta #FF00FF
   =========================== */
:root {
  /* Brand Colors */
  --k-orange: #FF8C00;
  --k-yellow: #FFD700;
  --k-cyan: #00D4FF;
  --k-red: #FF1744;
  --k-blue: #2979FF;
  --k-magenta: #FF00FF;
  
  /* Surfaces */
  --bg-primary: #0A0A0B;
  --bg-secondary: #111114;
  --bg-card: #16161A;
  --bg-card-hover: #1C1C21;
  --bg-elevated: #1E1E24;
  --bg-input: #1A1A1F;
  
  /* Text */
  --text-primary: #F0F0F2;
  --text-secondary: #9A9AA8;
  --text-muted: #6A6A78;
  --text-accent: var(--k-cyan);
  
  /* Borders */
  --border-subtle: rgba(255,255,255,0.06);
  --border-medium: rgba(255,255,255,0.1);
  --border-accent: rgba(0,212,255,0.3);
  
  /* Gradients */
  --grad-brand: linear-gradient(135deg, var(--k-orange), var(--k-red), var(--k-magenta));
  --grad-cool: linear-gradient(135deg, var(--k-cyan), var(--k-blue));
  --grad-warm: linear-gradient(135deg, var(--k-orange), var(--k-yellow));
  --grad-full: linear-gradient(135deg, var(--k-orange), var(--k-red), var(--k-magenta), var(--k-blue), var(--k-cyan));
  
  /* Effects */
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
  --shadow-glow-cyan: 0 0 30px rgba(0,212,255,0.15);
  --shadow-glow-orange: 0 0 30px rgba(255,140,0,0.15);
  
  --radius: 12px;
  --radius-lg: 18px;
  --radius-xl: 24px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Sora', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--k-blue); border-radius: 3px; }

::selection {
  background: rgba(0,212,255,0.25);
  color: var(--text-primary);
}

/* ===== HEADER ===== */
.site-header {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 1000;
  background: rgba(10,10,11,0.85);
  backdrop-filter: blur(24px) saturate(1.2);
  border-bottom: 1px solid var(--border-subtle);
  transition: all 0.4s;
}
.site-header.scrolled { border-color: var(--border-medium); }
.header-inner {
  max-width: 1320px;
  margin: 0 auto;
  padding: 0 2rem;
  height: 68px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.logo {
  display: flex;
  align-items: center;
  gap: 0.65rem;
  text-decoration: none;
}
.logo img {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  object-fit: cover;
}
.logo-text {
  font-family: 'DM Serif Display', serif;
  font-size: 1.3rem;
  color: var(--text-primary);
  letter-spacing: -0.01em;
}
.logo-text span {
  background: var(--grad-warm);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.nav-links {
  display: flex; gap: 1.5rem; align-items: center; list-style: none;
}
.nav-links a {
  text-decoration: none; color: var(--text-secondary); font-size: 0.82rem; font-weight: 500;
  transition: color 0.3s; cursor: pointer;
}
.nav-links a:hover { color: var(--text-primary); }
.nav-progress {
  font-size: 0.78rem; color: var(--text-muted);
}
.nav-progress strong {
  color: var(--k-cyan); font-weight: 600;
}
.header-progress {
  position: absolute; bottom: 0; left: 0; height: 2px;
  background: var(--grad-full);
  transition: width 0.6s ease; border-radius: 1px;
}

/* Auth button */
.btn-auth {
  padding: 0.5rem 1.25rem;
  background: var(--bg-card);
  color: var(--text-primary);
  border: 1px solid var(--border-medium);
  border-radius: 100px;
  font-family: 'Sora', sans-serif;
  font-size: 0.8rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s;
}
.btn-auth:hover {
  border-color: var(--k-cyan);
  background: var(--bg-elevated);
}
.user-avatar {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--grad-cool);
  display: flex; align-items: center; justify-content: center;
  font-size: 0.75rem; font-weight: 600; color: white;
  cursor: pointer; transition: all 0.3s;
}
.user-avatar:hover { box-shadow: var(--shadow-glow-cyan); }

/* ===== AUTH MODAL ===== */
.auth-overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 2000;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  align-items: center;
  justify-content: center;
}
.auth-overlay.visible { display: flex; }
.auth-modal {
  background: var(--bg-card);
  border: 1px solid var(--border-medium);
  border-radius: var(--radius-xl);
  padding: 2.5rem;
  width: 100%;
  max-width: 420px;
  position: relative;
  box-shadow: var(--shadow-lg);
}
.auth-modal-close {
  position: absolute; top: 1rem; right: 1rem;
  background: none; border: none; color: var(--text-muted);
  cursor: pointer; font-size: 1.2rem; transition: color 0.3s;
}
.auth-modal-close:hover { color: var(--text-primary); }
.auth-modal h2 {
  font-family: 'DM Serif Display', serif;
  font-size: 1.6rem; margin-bottom: 0.35rem;
}
.auth-modal p {
  color: var(--text-secondary); font-size: 0.88rem; margin-bottom: 1.5rem;
}
.auth-form { display: flex; flex-direction: column; gap: 1rem; }
.auth-input {
  padding: 0.85rem 1rem;
  background: var(--bg-input);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-family: 'Sora', sans-serif;
  font-size: 0.88rem;
  transition: border-color 0.3s;
  outline: none;
}
.auth-input:focus { border-color: var(--k-cyan); }
.auth-input::placeholder { color: var(--text-muted); }
.btn-submit {
  padding: 0.9rem;
  background: var(--grad-cool);
  color: white;
  border: none;
  border-radius: var(--radius);
  font-family: 'Sora', sans-serif;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}
.btn-submit:hover { transform: translateY(-1px); box-shadow: var(--shadow-glow-cyan); }
.btn-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.auth-toggle {
  text-align: center; margin-top: 1rem; font-size: 0.82rem; color: var(--text-muted);
}
.auth-toggle a {
  color: var(--k-cyan); cursor: pointer; text-decoration: none;
}
.auth-error {
  background: rgba(255,23,68,0.1);
  border: 1px solid rgba(255,23,68,0.2);
  border-radius: 8px;
  padding: 0.65rem 1rem;
  font-size: 0.82rem;
  color: var(--k-red);
  display: none;
}
.auth-error.visible { display: block; }
.auth-success {
  background: rgba(0,212,255,0.1);
  border: 1px solid rgba(0,212,255,0.2);
  border-radius: 8px;
  padding: 0.65rem 1rem;
  font-size: 0.82rem;
  color: var(--k-cyan);
  display: none;
}
.auth-success.visible { display: block; }

/* ===== HERO ===== */
.hero {
  min-height: 100vh;
  display: flex; align-items: center; justify-content: center;
  padding: 7rem 2rem 5rem;
  position: relative; overflow: hidden;
}
.hero-bg {
  position: absolute; inset: 0; pointer-events: none;
}
.hero-bg .orb {
  position: absolute; border-radius: 50%; filter: blur(120px); opacity: 0.12;
}
.hero-bg .orb-1 { top: -15%; right: -10%; width: 600px; height: 600px; background: var(--k-orange); }
.hero-bg .orb-2 { bottom: -20%; left: -10%; width: 500px; height: 500px; background: var(--k-blue); }
.hero-bg .orb-3 { top: 40%; left: 50%; width: 300px; height: 300px; background: var(--k-magenta); opacity: 0.06; }
.hero-grid {
  position: absolute; inset: 0;
  background-image: 
    linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
  background-size: 60px 60px;
  mask-image: radial-gradient(ellipse 60% 60% at 50% 50%, black 20%, transparent 100%);
}
.hero-content {
  max-width: 860px; text-align: center; position: relative; z-index: 1;
}
.hero-badge {
  display: inline-flex; align-items: center; gap: 0.5rem;
  padding: 0.45rem 1.1rem;
  background: rgba(255,140,0,0.08);
  border: 1px solid rgba(255,140,0,0.2);
  border-radius: 100px;
  font-size: 0.72rem; font-weight: 600;
  letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--k-orange);
  margin-bottom: 2rem;
  opacity: 0; animation: fadeUp 0.7s ease 0.2s forwards;
}
.hero-badge .dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--k-orange);
  animation: pulse 2s ease-in-out infinite;
}
.hero h1 {
  font-family: 'DM Serif Display', serif;
  font-size: clamp(2.8rem, 6vw, 4.8rem);
  font-weight: 400;
  line-height: 1.1;
  margin-bottom: 1.5rem;
  letter-spacing: -0.02em;
  opacity: 0; animation: fadeUp 0.7s ease 0.35s forwards;
}
.hero h1 .gradient-text {
  background: var(--grad-full);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.hero-sub {
  font-size: 1.1rem; color: var(--text-secondary);
  max-width: 560px; margin: 0 auto 2.5rem;
  font-weight: 300; line-height: 1.75;
  opacity: 0; animation: fadeUp 0.7s ease 0.5s forwards;
}
.hero-stats {
  display: flex; justify-content: center; gap: 3rem;
  margin-bottom: 2.5rem;
  opacity: 0; animation: fadeUp 0.7s ease 0.65s forwards;
}
.hero-stat-num {
  font-family: 'DM Serif Display', serif;
  font-size: 2.2rem; color: var(--text-primary);
}
.hero-stat-label {
  font-size: 0.72rem; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.1em;
}
.hero-cta-group {
  display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;
  opacity: 0; animation: fadeUp 0.7s ease 0.8s forwards;
}
.btn-cta {
  display: inline-flex; align-items: center; gap: 0.6rem;
  padding: 0.95rem 2.2rem;
  border-radius: 100px;
  font-family: 'Sora', sans-serif;
  font-size: 0.9rem; font-weight: 600;
  cursor: pointer; transition: all 0.4s ease;
  text-decoration: none; border: none;
}
.btn-cta-primary {
  background: var(--text-primary); color: var(--bg-primary);
}
.btn-cta-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(240,240,242,0.15);
}
.btn-cta-secondary {
  background: transparent; color: var(--text-secondary);
  border: 1px solid var(--border-medium);
}
.btn-cta-secondary:hover {
  border-color: var(--k-cyan); color: var(--k-cyan);
  transform: translateY(-2px);
}

/* ===== FEATURES ===== */
.section { max-width: 1320px; margin: 0 auto; padding: 0 2rem 6rem; }
.section-header { text-align: center; margin-bottom: 3.5rem; }
.section-header h2 {
  font-family: 'DM Serif Display', serif;
  font-size: 2.4rem; font-weight: 400; margin-bottom: 0.6rem;
}
.section-header p { color: var(--text-secondary); font-size: 1rem; font-weight: 300; }

.features-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.25rem;
}
.feature-card {
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  padding: 2rem;
  transition: all 0.4s ease;
  position: relative; overflow: hidden;
}
.feature-card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  opacity: 0; transition: opacity 0.4s;
}
.feature-card:nth-child(1)::before { background: var(--k-orange); }
.feature-card:nth-child(2)::before { background: var(--k-cyan); }
.feature-card:nth-child(3)::before { background: var(--k-magenta); }
.feature-card:nth-child(4)::before { background: var(--k-yellow); }
.feature-card:nth-child(5)::before { background: var(--k-blue); }
.feature-card:nth-child(6)::before { background: var(--k-red); }
.feature-card:hover {
  border-color: var(--border-medium);
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}
.feature-card:hover::before { opacity: 1; }
.feature-icon {
  width: 44px; height: 44px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.25rem; margin-bottom: 1.25rem;
}
.feature-card:nth-child(1) .feature-icon { background: rgba(255,140,0,0.1); }
.feature-card:nth-child(2) .feature-icon { background: rgba(0,212,255,0.1); }
.feature-card:nth-child(3) .feature-icon { background: rgba(255,0,255,0.1); }
.feature-card:nth-child(4) .feature-icon { background: rgba(255,215,0,0.1); }
.feature-card:nth-child(5) .feature-icon { background: rgba(41,121,255,0.1); }
.feature-card:nth-child(6) .feature-icon { background: rgba(255,23,68,0.1); }
.feature-card h3 {
  font-family: 'DM Serif Display', serif;
  font-size: 1.15rem; margin-bottom: 0.5rem;
}
.feature-card p { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.65; }

/* Module preview cards */
.module-preview-grid {
  display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem; margin-bottom: 3rem;
}
.module-preview {
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  padding: 2rem;
  cursor: pointer; transition: all 0.4s ease;
  position: relative; overflow: hidden;
}
.module-preview:hover {
  transform: translateY(-3px);
  border-color: var(--border-medium);
  box-shadow: var(--shadow-md);
}
.module-preview-num {
  font-family: 'DM Serif Display', serif;
  font-size: 3.5rem; font-weight: 400;
  position: absolute; top: 0.25rem; right: 1.5rem;
  line-height: 1;
  opacity: 0.06; color: var(--text-primary);
}
.module-preview-label {
  font-size: 0.68rem; font-weight: 600;
  letter-spacing: 0.14em; text-transform: uppercase;
  margin-bottom: 0.5rem;
}
.module-preview:nth-child(1) .module-preview-label { color: var(--k-orange); }
.module-preview:nth-child(2) .module-preview-label { color: var(--k-cyan); }
.module-preview:nth-child(3) .module-preview-label { color: var(--k-blue); }
.module-preview:nth-child(4) .module-preview-label { color: var(--k-yellow); }
.module-preview:nth-child(5) .module-preview-label { color: var(--k-red); }
.module-preview:nth-child(6) .module-preview-label { color: var(--k-magenta); }
.module-preview h3 {
  font-family: 'DM Serif Display', serif;
  font-size: 1.25rem; margin-bottom: 0.3rem; line-height: 1.3;
}
.module-preview .theme {
  font-size: 0.82rem; color: var(--text-muted);
  font-style: italic; font-family: 'DM Serif Display', serif;
  margin-bottom: 0.75rem;
}
.module-preview .lessons-count {
  font-size: 0.75rem; color: var(--text-muted);
}

/* Scripture */
.scripture-block {
  text-align: center; padding: 4rem 2rem; max-width: 680px; margin: 0 auto 2rem;
}
.scripture-block blockquote {
  font-family: 'DM Serif Display', serif;
  font-size: 1.5rem; font-style: italic;
  color: var(--text-secondary); line-height: 1.5; margin-bottom: 0.75rem;
}
.scripture-block cite {
  font-family: 'Sora', sans-serif;
  font-size: 0.78rem; font-style: normal;
  color: var(--k-orange); letter-spacing: 0.06em; font-weight: 500;
}

/* ===== COURSE LAYOUT ===== */
.course-layout {
  display: grid; grid-template-columns: 320px 1fr; gap: 2.5rem;
  max-width: 1320px; margin: 0 auto; padding: 0 2rem 6rem;
}

/* Sidebar */
.sidebar {
  position: sticky; top: 88px;
  height: fit-content; max-height: calc(100vh - 108px);
  overflow-y: auto; padding-right: 0.75rem;
}
.sidebar::-webkit-scrollbar { width: 3px; }
.sidebar::-webkit-scrollbar-thumb { background: var(--k-blue); border-radius: 3px; }

.overall-progress {
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius);
  padding: 1.25rem; margin-bottom: 1.25rem;
}
.overall-progress-label {
  display: flex; justify-content: space-between;
  font-size: 0.78rem; color: var(--text-muted); margin-bottom: 0.5rem;
}
.overall-progress-label strong { color: var(--k-cyan); }
.progress-bar-track {
  height: 5px; background: var(--bg-elevated);
  border-radius: 3px; overflow: hidden;
}
.progress-bar-fill {
  height: 100%; background: var(--grad-cool);
  border-radius: 3px; transition: width 0.6s ease;
}

.module-nav-btn {
  width: 100%;
  display: flex; align-items: center; gap: 0.7rem;
  padding: 0.75rem 0.85rem;
  background: transparent;
  border: 1px solid transparent;
  border-radius: var(--radius);
  cursor: pointer; font-family: 'Sora', sans-serif;
  font-size: 0.82rem; font-weight: 500;
  color: var(--text-muted); text-align: left;
  transition: all 0.3s ease; margin-bottom: 0.2rem;
}
.module-nav-btn:hover {
  background: var(--bg-card);
  color: var(--text-secondary);
}
.module-nav-btn.active {
  background: var(--bg-card);
  border-color: var(--border-medium);
  color: var(--text-primary);
}
.mod-num {
  width: 26px; height: 26px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem; font-weight: 700;
  background: var(--bg-elevated); color: var(--text-muted);
  flex-shrink: 0; transition: all 0.3s;
}
.module-nav-btn.active .mod-num {
  background: var(--grad-cool); color: white;
}
.module-nav-btn.completed .mod-num {
  background: #1a3a2a; color: #4ade80;
}
.mod-dots {
  display: flex; gap: 3px; margin-top: 0.15rem; padding-left: 2.85rem;
}
.mod-dot {
  width: 16px; height: 3px; border-radius: 2px;
  background: var(--bg-elevated); transition: background 0.3s;
}
.mod-dot.done { background: #4ade80; }
.mod-dot.current { background: var(--k-cyan); }

/* ===== MAIN CONTENT ===== */
.main-content { min-height: 80vh; }

.module-header {
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  padding: 2.5rem; margin-bottom: 1.25rem;
  position: relative; overflow: hidden;
}
.module-header::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: var(--grad-full);
}
.module-badge {
  display: inline-flex; align-items: center; gap: 0.4rem;
  font-size: 0.68rem; font-weight: 700;
  letter-spacing: 0.14em; text-transform: uppercase;
  color: var(--k-cyan); margin-bottom: 0.75rem;
}
.module-header h2 {
  font-family: 'DM Serif Display', serif;
  font-size: 1.9rem; font-weight: 400; line-height: 1.25; margin-bottom: 0.4rem;
}
.module-theme {
  font-size: 0.92rem; color: var(--text-muted);
  font-style: italic; font-family: 'DM Serif Display', serif;
}

/* Lesson Cards */
.lesson-card {
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  margin-bottom: 0.75rem;
  overflow: hidden; transition: all 0.3s ease;
}
.lesson-card:hover {
  border-color: var(--border-medium);
}
.lesson-card.active {
  border-color: var(--k-cyan);
  box-shadow: var(--shadow-glow-cyan);
}
.lesson-card.done { border-left: 3px solid #4ade80; }

.lesson-header {
  padding: 1.25rem 1.75rem;
  display: flex; align-items: center; gap: 1.1rem;
  cursor: pointer; transition: background 0.2s;
}
.lesson-header:hover { background: var(--bg-card-hover); }

.lesson-num {
  width: 40px; height: 40px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'DM Serif Display', serif;
  font-size: 1.05rem; font-weight: 400;
  background: var(--bg-elevated); color: var(--text-muted);
  flex-shrink: 0; transition: all 0.4s;
}
.lesson-card.active .lesson-num { background: var(--grad-cool); color: white; }
.lesson-card.done .lesson-num { background: #1a3a2a; color: #4ade80; }

.lesson-info { flex: 1; }
.lesson-title {
  font-size: 0.95rem; font-weight: 600; color: var(--text-primary);
  margin-bottom: 0.1rem;
}
.lesson-meta {
  font-size: 0.75rem; color: var(--text-muted);
  display: flex; gap: 0.75rem;
}

.lesson-toggle {
  width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 8px; background: var(--bg-elevated);
  transition: all 0.3s; flex-shrink: 0;
}
.lesson-card.active .lesson-toggle { transform: rotate(180deg); }

.lesson-content {
  max-height: 0; overflow: hidden;
  transition: max-height 0.5s ease;
}
.lesson-card.active .lesson-content {
  max-height: 800px;
  padding: 0 1.75rem 1.75rem 4.6rem;
}

.lesson-body {
  padding-top: 0.75rem;
  border-top: 1px solid var(--border-subtle);
}
.lesson-topics { list-style: none; margin: 0.75rem 0; }
.lesson-topics li {
  padding: 0.55rem 0; padding-left: 1.25rem;
  position: relative; color: var(--text-secondary);
  font-size: 0.87rem; border-bottom: 1px solid var(--border-subtle);
}
.lesson-topics li:last-child { border-bottom: none; }
.lesson-topics li::before {
  content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%);
  width: 5px; height: 5px; border-radius: 50%; background: var(--k-cyan); opacity: 0.5;
}

.completion-check {
  display: flex; align-items: center; gap: 0.5rem;
  margin-top: 1rem; cursor: pointer; font-size: 0.82rem;
  color: var(--text-muted);
}
.completion-check input { display: none; }
.check-box {
  width: 20px; height: 20px;
  border: 2px solid var(--border-medium);
  border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.3s; flex-shrink: 0;
}
.completion-check:hover .check-box { border-color: var(--k-cyan); }
.completion-check input:checked ~ .check-box {
  background: #1a3a2a; border-color: #4ade80; color: #4ade80;
}
.completion-check input:checked ~ .check-box::after { content: '‚úì'; font-size: 0.65rem; font-weight: 700; }

.lesson-actions {
  display: flex; gap: 0.6rem; margin-top: 1.1rem;
}
.btn-lesson {
  padding: 0.6rem 1.4rem; border-radius: 100px;
  font-family: 'Sora', sans-serif; font-size: 0.8rem; font-weight: 600;
  cursor: pointer; transition: all 0.3s; border: none;
}
.btn-primary { background: var(--text-primary); color: var(--bg-primary); }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(240,240,242,0.15); }
.btn-secondary {
  background: transparent; color: var(--text-secondary);
  border: 1px solid var(--border-medium);
}
.btn-secondary:hover { border-color: var(--k-cyan); color: var(--k-cyan); }

/* Next module */
.next-module-card {
  text-align: center; padding: 2.5rem;
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  margin-top: 1rem;
}
.next-module-card p { color: var(--text-muted); font-size: 0.82rem; margin-bottom: 0.75rem; }

/* ===== VIEWS ===== */
.view { display: none; }
.view.visible { display: block; }

/* ===== FOOTER ===== */
.site-footer {
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-subtle);
  padding: 2.5rem 2rem;
  text-align: center; font-size: 0.82rem;
  color: var(--text-muted);
}
.site-footer a { color: var(--k-cyan); text-decoration: none; }
.footer-brand {
  font-family: 'DM Serif Display', serif;
  font-size: 1.1rem; color: var(--text-secondary);
  margin-bottom: 0.5rem;
}

/* ===== ANIMATIONS ===== */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}
.fade-in { opacity: 0; animation: fadeIn 0.5s ease forwards; }

/* ===== RESPONSIVE ===== */
@media (max-width: 1024px) {
  .course-layout { grid-template-columns: 260px 1fr; gap: 1.5rem; }
/* ===== LESSON VIDEO ===== */
.lesson-video { width:100%; border-radius:12px; margin-bottom:1rem; background:var(--bg-primary); }
.lesson-video video { width:100%; border-radius:12px; display:block; }

/* ===== LESSON NOTES FROM ADMIN ===== */
.admin-notes { background:rgba(0,212,255,0.04); border:1px solid rgba(0,212,255,0.1); border-radius:10px; padding:1.25rem; margin:1rem 0; font-size:0.88rem; color:var(--text-secondary); line-height:1.7; }
.admin-notes h4 { color:var(--text-primary); font-size:0.82rem; margin-bottom:0.5rem; }

/* ===== QUIZ ===== */
.quiz-container { background:var(--bg-card); border:1px solid rgba(255,140,0,0.2); border-radius:12px; padding:1.5rem; margin:1rem 0; }
.quiz-container h4 { font-family:'DM Serif Display',serif; font-size:1.05rem; margin-bottom:1rem; color:var(--k-orange); display:flex; align-items:center; gap:0.5rem; }
.quiz-q { margin-bottom:1.25rem; padding-bottom:1.25rem; border-bottom:1px solid var(--border-subtle); }
.quiz-q:last-of-type { border-bottom:none; margin-bottom:0.75rem; }
.quiz-q-text { font-size:0.9rem; font-weight:600; margin-bottom:0.6rem; color:var(--text-primary); }
.quiz-q-num { color:var(--k-orange); font-size:0.78rem; margin-bottom:0.25rem; }
.quiz-opt { display:flex; align-items:center; gap:0.6rem; padding:0.55rem 0.85rem; margin:0.3rem 0; border-radius:8px; cursor:pointer; font-size:0.85rem; color:var(--text-secondary); transition:all 0.2s; border:1px solid transparent; }
.quiz-opt:hover { background:rgba(255,255,255,0.03); }
.quiz-opt.selected { background:rgba(0,212,255,0.08); border-color:rgba(0,212,255,0.2); color:var(--text-primary); }
.quiz-opt.correct { background:rgba(74,222,128,0.1); border-color:rgba(74,222,128,0.3); color:#4ade80; }
.quiz-opt.wrong { background:rgba(255,23,68,0.08); border-color:rgba(255,23,68,0.2); color:var(--k-red); }
.quiz-radio { width:16px; height:16px; border-radius:50%; border:2px solid var(--border-medium); flex-shrink:0; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
.quiz-opt.selected .quiz-radio { border-color:var(--k-cyan); background:var(--k-cyan); }
.quiz-opt.selected .quiz-radio::after { content:''; width:6px; height:6px; border-radius:50%; background:white; }
.quiz-opt.correct .quiz-radio { border-color:#4ade80; background:#4ade80; }
.quiz-opt.wrong .quiz-radio { border-color:var(--k-red); background:var(--k-red); }
.quiz-btn { margin-top:0.75rem; }
.quiz-result { padding:1rem; border-radius:10px; margin-top:0.75rem; font-size:0.88rem; font-weight:600; text-align:center; }
.quiz-result.pass { background:rgba(74,222,128,0.1); color:#4ade80; border:1px solid rgba(74,222,128,0.2); }
.quiz-result.fail { background:rgba(255,23,68,0.08); color:var(--k-red); border:1px solid rgba(255,23,68,0.15); }
.quiz-locked { display:flex; align-items:center; gap:0.5rem; padding:0.75rem 1rem; background:rgba(255,140,0,0.06); border:1px solid rgba(255,140,0,0.15); border-radius:10px; margin-top:1rem; font-size:0.82rem; color:var(--k-orange); }

/* ===== NOTE EDITOR MODAL ===== */
.note-modal { position:fixed; inset:0; z-index:2000; background:rgba(0,0,0,0.7); backdrop-filter:blur(6px); display:none; align-items:center; justify-content:center; }
.note-modal.visible { display:flex; }
.note-modal-box { background:var(--bg-card); border:1px solid var(--border-medium); border-radius:18px; padding:2rem; width:100%; max-width:560px; }
.note-modal-box h3 { font-family:'DM Serif Display',serif; margin-bottom:1rem; }
.note-modal-box textarea { width:100%; min-height:200px; padding:1rem; background:var(--bg-input); border:1px solid var(--border-subtle); border-radius:10px; color:var(--text-primary); font-family:'Sora',sans-serif; font-size:0.88rem; outline:none; resize:vertical; }
.note-modal-box textarea:focus { border-color:var(--k-cyan); }

}
@media (max-width: 768px) {
  .course-layout { grid-template-columns: 1fr; }
  .sidebar {
    position: relative; top: 0; max-height: none;
    display: flex; overflow-x: auto; gap: 0.35rem;
    padding-bottom: 1rem; padding-right: 0;
  }
  .module-nav-item { flex-shrink: 0; }
  .mod-dots, .overall-progress { display: none; }
  .features-grid { grid-template-columns: 1fr; }
  .module-preview-grid { grid-template-columns: 1fr; }
  .hero-stats { gap: 1.5rem; }
  .nav-links .hide-mobile { display: none; }
  .lesson-card.active .lesson-content { padding-left: 1.75rem; }
  .header-inner { padding: 0 1rem; }
  .course-layout, .section { padding-left: 1rem; padding-right: 1rem; }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="site-header" id="siteHeader">
  <div class="header-inner">
    <a class="logo" href="#" onclick="showWelcome(); return false;">
      <img src="/images/logo.jpg" alt="Kratos Publisher">
      <span class="logo-text"><span>Kratos</span> Publisher</span>
    </a>
    <ul class="nav-links">
      <li class="hide-mobile"><a href="#" onclick="showWelcome(); return false;">Home</a></li>
      <li class="hide-mobile"><a href="#" onclick="startCourse(); return false;">Curriculum</a></li>
      <li class="nav-progress hide-mobile">Progress: <strong id="progressPct">0%</strong></li>
      <li id="authContainer"></li>
    </ul>
  </div>
  <div class="header-progress" id="headerProgress" style="width:0%"></div>
</header>

<!-- AUTH MODAL -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-modal">
    <button class="auth-modal-close" onclick="closeAuth()">‚úï</button>
    <h2 id="authTitle">Welcome Back</h2>
    <p id="authSubtitle">Sign in to track your progress</p>
    <div class="auth-error" id="authError"></div>
    <div class="auth-success" id="authSuccess"></div>
    <form class="auth-form" id="authForm" onsubmit="handleAuth(event)">
      <input class="auth-input" type="text" id="authName" placeholder="Full name" style="display:none">
      <input class="auth-input" type="email" id="authEmail" placeholder="Email address" required>
      <input class="auth-input" type="password" id="authPassword" placeholder="Password" required minlength="6">
      <button class="btn-submit" type="submit" id="authSubmit">Sign In</button>
    </form>
    <div class="auth-toggle">
      <span id="authToggleText">Don't have an account?</span>
      <a id="authToggleLink" href="#" onclick="toggleAuthMode(); return false;"> Sign Up</a>
    </div>
  </div>
</div>

<!-- ===== WELCOME VIEW ===== -->
<div class="view visible" id="welcomeView">
  <section class="hero">
    <div class="hero-bg">
      <div class="orb orb-1"></div>
      <div class="orb orb-2"></div>
      <div class="orb orb-3"></div>
      <div class="hero-grid"></div>
    </div>
    <div class="hero-content">
      <div class="hero-badge">
        <span class="dot"></span>
        Kratos Publisher Academy
      </div>
      <h1>From Calling to<br><span class="gradient-text">Published Author</span></h1>
      <p class="hero-sub">A comprehensive 18-lesson journey for Christian writers who believe God has placed a book on their heart ‚Äî and want to steward it with excellence.</p>
      <div class="hero-stats">
        <div class="hero-stat"><div class="hero-stat-num">6</div><div class="hero-stat-label">Modules</div></div>
        <div class="hero-stat"><div class="hero-stat-num">18</div><div class="hero-stat-label">Lessons</div></div>
        <div class="hero-stat"><div class="hero-stat-num">‚àû</div><div class="hero-stat-label">Impact</div></div>
      </div>
      <div class="hero-cta-group" id="heroCtas">
        <a class="btn-cta btn-cta-primary" href="#" onclick="startCourse(); return false;">
          Begin Your Journey
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </a>
        <a class="btn-cta btn-cta-secondary" href="#" onclick="openAuth(); return false;">
          Sign In to Save Progress
        </a>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="scripture-block">
      <blockquote>"Whatever you do, work at it with all your heart, as working for the Lord."</blockquote>
      <cite>‚Äî Colossians 3:23 (NIV)</cite>
    </div>

    <div class="section-header">
      <h2>What You'll Learn</h2>
      <p>Six modules covering every stage of the Christian publishing journey</p>
    </div>

    <div class="features-grid">
      <div class="feature-card">
        <div class="feature-icon">üïäÔ∏è</div>
        <h3>Discern Your Calling</h3>
        <p>Distinguish God's timing from personal ambition through prayer, discernment, and confirmation.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üìñ</div>
        <h3>Write with Excellence</h3>
        <p>Structure your book, create writing schedules, and overcome fear while honoring God with your craft.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üõ§Ô∏è</div>
        <h3>Choose Your Path</h3>
        <p>Understand traditional, self, and hybrid publishing to find the right fit for your ministry.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">‚öñÔ∏è</div>
        <h3>Handle the Business</h3>
        <p>Navigate ISBNs, copyrights, cover design, pricing, and distribution with integrity.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üöÄ</div>
        <h3>Launch Faithfully</h3>
        <p>Prepare spiritually and practically for launch with marketing strategies that honor your mission.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üå±</div>
        <h3>Grow Your Ministry</h3>
        <p>Build a lasting author platform, use your book for discipleship, and think legacy.</p>
      </div>
    </div>

    <div class="section-header" style="margin-top:2rem;">
      <h2>Course Modules</h2>
      <p>Click any module to jump right in</p>
    </div>

    <div class="module-preview-grid" id="modulePreviewGrid"></div>

    <div style="text-align:center; padding: 2rem 0;">
      <a class="btn-cta btn-cta-primary" href="#" onclick="startCourse(); return false;" style="opacity:1;animation:none;">
        Start Learning ‚Üí
      </a>
    </div>
  </section>
</div>

<!-- ===== COURSE VIEW ===== -->
<div class="view" id="courseView">
  <div style="padding-top: 86px;"></div>
  <div class="course-layout">
    <aside class="sidebar" id="sidebar"></aside>
    <main class="main-content" id="mainContent"></main>
  </div>
</div>

<!-- FOOTER -->
<footer class="site-footer">
  <div class="footer-brand">Kratos Publisher</div>
  <p>¬© 2026 Kratos Publisher ‚Äî A faith-based course for aspiring Christian authors.</p>
  <p style="margin-top:0.4rem;">Built with prayer and purpose.</p>
</footer>

<script>
// ========== COURSE DATA ==========
const courseData = [
  {
    id: 1, title: "The Calling & Clarity Stage",
    theme: "Writing as ministry, not just a product",
    color: "var(--k-orange)",
    lessons: [
      { num: 1, title: "Is God Calling You to Write This Book?", duration: "25 min", type: "Video + Reflection",
        topics: ["Writing as stewardship","Distinguishing God's timing vs. personal ambition","Prayer, discernment, and confirmation"] },
      { num: 2, title: "Defining Your Message & Audience", duration: "20 min", type: "Workshop",
        topics: ["Who is this book for?","What problem does it solve spiritually?","Narrowing your Christian niche (devotional, theology, memoir, fiction, leadership, etc.)"] },
      { num: 3, title: "Choosing the Right Type of Christian Book", duration: "30 min", type: "Guide + Quiz",
        topics: ["Devotional","Bible study","Christian living","Memoir / testimony","Fiction","Ministry / leadership","How format affects publishing options"] }
    ]
  },
  {
    id: 2, title: "Preparing Your Manuscript for Publication",
    theme: "Excellence honors God",
    color: "var(--k-cyan)",
    lessons: [
      { num: 4, title: "Writing with Excellence (Not Perfectionism)", duration: "30 min", type: "Video + Exercises",
        topics: ["Structuring your book","Writing schedules for busy believers","Overcoming fear, doubt, and comparison"] },
      { num: 5, title: "Editing Your Christian Book", duration: "25 min", type: "Workshop",
        topics: ["Types of editing (developmental, copy, proof)","Faith-based editors vs. general editors","How to prepare spiritually and practically for feedback"] },
      { num: 6, title: "Beta Readers, Sensitivity & Theology Checks", duration: "20 min", type: "Checklist + Guide",
        topics: ["Who should review your book","Avoiding doctrinal confusion","Receiving critique with humility"] }
    ]
  },
  {
    id: 3, title: "Understanding Publishing Options",
    theme: "Choosing the path God has for your book",
    color: "var(--k-blue)",
    lessons: [
      { num: 7, title: "Traditional Christian Publishing", duration: "30 min", type: "Deep Dive",
        topics: ["How Christian publishers work","Pros and cons","What publishers look for","Timelines and expectations"] },
      { num: 8, title: "Self-Publishing for Christian Authors", duration: "35 min", type: "Step-by-Step Guide",
        topics: ["Amazon KDP, IngramSpark, etc.","Costs and responsibilities","When self-publishing makes sense for ministry"] },
      { num: 9, title: "Hybrid & Assisted Publishing", duration: "20 min", type: "Guide + Red Flags",
        topics: ["What hybrid publishing really is","How to avoid scams","Questions to ask before paying anyone"] }
    ]
  },
  {
    id: 4, title: "The Business Side (Handled with Integrity)",
    theme: "Faithful stewardship of resources",
    color: "var(--k-yellow)",
    lessons: [
      { num: 10, title: "ISBNs, Copyright, & Legal Basics", duration: "25 min", type: "Reference Guide",
        topics: ["Copyrighting your work","ISBNs explained","Pen names and ministries"] },
      { num: 11, title: "Book Cover & Interior Design", duration: "30 min", type: "Visual Workshop",
        topics: ["Why Christian readers judge covers","What makes a Christian cover effective","Working with designers"] },
      { num: 12, title: "Pricing & Distribution", duration: "20 min", type: "Strategy Session",
        topics: ["Pricing for ministry vs. profit","Print, ebook, audiobook options","Churches, bookstores, and online platforms"] }
    ]
  },
  {
    id: 5, title: "Launching Your Christian Book",
    theme: "Faith + strategy",
    color: "var(--k-red)",
    lessons: [
      { num: 13, title: "Preparing for Launch (Spiritually & Practically)", duration: "25 min", type: "Action Plan",
        topics: ["Prayer teams","Soft vs. hard launches","Setting realistic expectations"] },
      { num: 14, title: "Marketing Without Compromising Your Faith", duration: "35 min", type: "Strategy Workshop",
        topics: ["Email lists","Social media (without burnout)","Speaking engagements, churches, podcasts","Reviews and testimonials"] },
      { num: 15, title: "Launch Day & Beyond", duration: "20 min", type: "Guide + Reflection",
        topics: ["What actually matters on launch day","Common mistakes Christian authors make","Staying faithful after the excitement fades"] }
    ]
  },
  {
    id: 6, title: "Long-Term Impact & Ministry Growth",
    theme: "Faithfulness after publication",
    color: "var(--k-magenta)",
    lessons: [
      { num: 16, title: "Using Your Book for Ministry", duration: "25 min", type: "Strategy Session",
        topics: ["Teaching, discipleship, small groups","Church partnerships","Missions and outreach"] },
      { num: 17, title: "Building an Author Platform God Can Use", duration: "30 min", type: "Workshop",
        topics: ["Authority without pride","Consistency without pressure","Boundaries for ministry authors"] },
      { num: 18, title: "Next Steps After Your First Book", duration: "20 min", type: "Vision Casting",
        topics: ["Should you write another?","Expanding formats (workbooks, studies)","Legacy thinking"] }
    ]
  }
];

// ========== SUPABASE CONFIG ==========
// Replace these with your Supabase project credentials
const SUPABASE_URL = 'https://ywpdiapocrjzabnqixoq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3cGRpYXBvY3JqemFibnFpeG9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MTE1MDAsImV4cCI6MjA4NzQ4NzUwMH0.nlOpULiCGsXPzqcs9phd4MNccpxRCjDoxXoPReeIPNg';
let sb = null;
let currentUser = null;

if (SUPABASE_URL && SUPABASE_ANON_KEY) {
  sb = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
}

// ========== STATE ==========
let currentModule = 0;
let completedLessons = new Set();
let activeLessonCard = null;
let authMode = 'signin'; // 'signin' or 'signup'

// Load local progress
try {
  const saved = localStorage.getItem('kratos_progress');
  if (saved) completedLessons = new Set(JSON.parse(saved));
} catch(e) {}

function saveProgress() {
  try {
    localStorage.setItem('kratos_progress', JSON.stringify([...completedLessons]));
  } catch(e) {}
  // Save to Supabase if logged in (per-lesson tracking)
  if (sb && currentUser) {
    completedLessons.forEach(lessonNum => {
      sb.from('user_progress').upsert({
        user_id: currentUser.id,
        lesson_num: lessonNum,
        completed: true,
        completed_at: new Date().toISOString()
      }, { onConflict: 'user_id,lesson_num' }).then(() => {});
    });
    // Log activity
    sb.from('activity_log').insert({
      user_id: currentUser.id,
      action: 'progress_updated',
      metadata: { completed: [...completedLessons] }
    }).then(() => {});
  }
}

async function loadUserProgress() {
  if (!sb || !currentUser) return;
  try {
    const { data } = await sb
      .from('user_progress')
      .select('lesson_num')
      .eq('user_id', currentUser.id)
      .eq('completed', true);
    if (data?.length) {
      completedLessons = new Set(data.map(d => d.lesson_num));
      localStorage.setItem('kratos_progress', JSON.stringify([...completedLessons]));
    }
  } catch(e) {}
}

// ========== AUTH ==========
function openAuth() {
  document.getElementById('authOverlay').classList.add('visible');
  document.getElementById('authEmail').focus();
}
function closeAuth() {
  document.getElementById('authOverlay').classList.remove('visible');
  document.getElementById('authError').classList.remove('visible');
  document.getElementById('authSuccess').classList.remove('visible');
}
function toggleAuthMode() {
  authMode = authMode === 'signin' ? 'signup' : 'signin';
  document.getElementById('authTitle').textContent = authMode === 'signin' ? 'Welcome Back' : 'Create Account';
  document.getElementById('authSubtitle').textContent = authMode === 'signin' ? 'Sign in to track your progress' : 'Start your publishing journey';
  document.getElementById('authSubmit').textContent = authMode === 'signin' ? 'Sign In' : 'Create Account';
  document.getElementById('authToggleText').textContent = authMode === 'signin' ? "Don't have an account?" : 'Already have an account?';
  document.getElementById('authToggleLink').textContent = authMode === 'signin' ? ' Sign Up' : ' Sign In';
  document.getElementById('authName').style.display = authMode === 'signup' ? 'block' : 'none';
  document.getElementById('authName').required = authMode === 'signup';
  document.getElementById('authError').classList.remove('visible');
  document.getElementById('authSuccess').classList.remove('visible');
}

let userProfile = null;

async function handleAuth(e) {
  e.preventDefault();
  const name = document.getElementById('authName').value;
  const email = document.getElementById('authEmail').value;
  const password = document.getElementById('authPassword').value;
  const errEl = document.getElementById('authError');
  const successEl = document.getElementById('authSuccess');
  const btn = document.getElementById('authSubmit');
  
  errEl.classList.remove('visible');
  successEl.classList.remove('visible');
  btn.disabled = true;
  btn.textContent = 'Please wait...';
  
  if (!sb) {
    errEl.textContent = 'Authentication not configured.';
    errEl.classList.add('visible');
    btn.disabled = false;
    btn.textContent = authMode === 'signin' ? 'Sign In' : 'Create Account';
    return;
  }
  
  try {
    let result;
    if (authMode === 'signup') {
      result = await sb.auth.signUp({
        email,
        password,
        options: { data: { full_name: name } }
      });
      if (result.error) throw result.error;

      // Create profile immediately
      if (result.data.user) {
        await sb.from('profiles').upsert({
          id: result.data.user.id,
          email: email,
          full_name: name,
          role: 'student'
        }, { onConflict: 'id' });
      }

      successEl.textContent = 'Account created! You can now sign in.';
      successEl.classList.add('visible');
      
      // Auto sign in if no email confirmation required
      if (result.data.session) {
        currentUser = result.data.user;
        userProfile = { full_name: name, email, role: 'student' };
        await loadUserProgress();
        closeAuth();
        updateAuthUI();
        renderSidebar();
      }
    } else {
      result = await sb.auth.signInWithPassword({ email, password });
      if (result.error) throw result.error;
      
      currentUser = result.data.user;
      await loadProfile();
      await loadUserProgress();
      closeAuth();
      updateAuthUI();
      renderSidebar();
      if (document.getElementById('courseView').classList.contains('visible')) {
        renderMainContent();
      }
    }
  } catch (err) {
    errEl.textContent = err.message || 'Something went wrong. Try again.';
    errEl.classList.add('visible');
  }
  
  btn.disabled = false;
  btn.textContent = authMode === 'signin' ? 'Sign In' : 'Create Account';
}

async function loadProfile() {
  if (!sb || !currentUser) return;
  try {
    const { data } = await sb.from('profiles')
      .select('full_name, email, role')
      .eq('id', currentUser.id)
      .single();
    userProfile = data;
  } catch(e) { userProfile = null; }
}

async function signOut() {
  if (sb) await sb.auth.signOut();
  currentUser = null;
  userProfile = null;
  completedLessons = new Set();
  updateAuthUI();
  renderSidebar();
  showWelcome();
}

function updateAuthUI() {
  const container = document.getElementById('authContainer');
  const heroCtas = document.getElementById('heroCtas');
  if (currentUser) {
    const name = userProfile?.full_name || currentUser.email?.split('@')[0] || 'User';
    const initial = name[0].toUpperCase();
    container.innerHTML = `
      <div style="display:flex;align-items:center;gap:0.75rem;">
        <span style="font-size:0.8rem;color:var(--text-secondary);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${name}</span>
        <div class="user-avatar" onclick="toggleUserMenu()" title="${currentUser.email}">${initial}</div>
      </div>
      <div class="user-menu" id="userMenu" style="display:none;position:absolute;top:60px;right:2rem;background:var(--bg-card);border:1px solid var(--border-medium);border-radius:12px;padding:0.5rem;min-width:200px;box-shadow:0 8px 32px rgba(0,0,0,0.4);z-index:100;">
        <div style="padding:0.75rem;border-bottom:1px solid var(--border-subtle);">
          <div style="font-size:0.88rem;font-weight:600;color:var(--text-primary);">${name}</div>
          <div style="font-size:0.75rem;color:var(--text-muted);">${currentUser.email}</div>
        </div>
        <a href="/dashboard" style="display:block;padding:0.6rem 0.75rem;color:var(--text-secondary);text-decoration:none;font-size:0.82rem;border-radius:8px;transition:background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">üìä My Dashboard</a>
        <a href="#" onclick="showProfileEditor(); return false;" style="display:block;padding:0.6rem 0.75rem;color:var(--text-secondary);text-decoration:none;font-size:0.82rem;border-radius:8px;transition:background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">‚úèÔ∏è Edit Profile</a>
        <a href="#" onclick="signOut(); return false;" style="display:block;padding:0.6rem 0.75rem;color:var(--k-red);text-decoration:none;font-size:0.82rem;border-radius:8px;transition:background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">üö™ Sign Out</a>
      </div>
    `;
    // Update hero buttons when logged in
    if (heroCtas) {
      heroCtas.innerHTML = `
        <a class="btn-cta btn-cta-primary" href="#" onclick="startCourse(); return false;">
          Continue Learning
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </a>
        <a class="btn-cta btn-cta-secondary" href="/dashboard">
          My Dashboard
        </a>
      `;
    }
  } else {
    container.innerHTML = `
      <button class="btn-auth" onclick="openAuth()">Sign In</button>
    `;
    if (heroCtas) {
      heroCtas.innerHTML = `
        <a class="btn-cta btn-cta-primary" href="#" onclick="startCourse(); return false;">
          Begin Your Journey
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </a>
        <a class="btn-cta btn-cta-secondary" href="#" onclick="openAuth(); return false;">
          Sign In to Save Progress
        </a>
      `;
    }
  }
}

function toggleUserMenu() {
  const menu = document.getElementById('userMenu');
  if (menu) menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// Close menu on outside click
document.addEventListener('click', (e) => {
  const menu = document.getElementById('userMenu');
  if (menu && !e.target.closest('.user-avatar') && !e.target.closest('.user-menu')) {
    menu.style.display = 'none';
  }
});

function showProfileEditor() {
  const menu = document.getElementById('userMenu');
  if (menu) menu.style.display = 'none';
  
  const name = userProfile?.full_name || '';
  const overlay = document.getElementById('authOverlay');
  const modal = overlay.querySelector('.auth-modal');
  modal.innerHTML = `
    <button class="auth-modal-close" onclick="closeProfileEditor()">‚úï</button>
    <h2 style="font-family:'DM Serif Display',serif;">Edit Profile</h2>
    <p style="color:var(--text-secondary);font-size:0.88rem;margin-bottom:1.5rem;">${currentUser.email}</p>
    <form class="auth-form" onsubmit="saveProfile(event)">
      <input class="auth-input" type="text" id="profileName" placeholder="Full name" value="${name}" required>
      <button class="btn-submit" type="submit">Save Changes</button>
    </form>
  `;
  overlay.classList.add('visible');
}

function closeProfileEditor() {
  const overlay = document.getElementById('authOverlay');
  overlay.classList.remove('visible');
  // Restore original auth form
  const modal = overlay.querySelector('.auth-modal');
  modal.innerHTML = `
    <button class="auth-modal-close" onclick="closeAuth()">‚úï</button>
    <h2 id="authTitle">Welcome Back</h2>
    <p id="authSubtitle">Sign in to track your progress</p>
    <div class="auth-error" id="authError"></div>
    <div class="auth-success" id="authSuccess"></div>
    <form class="auth-form" id="authForm" onsubmit="handleAuth(event)">
      <input class="auth-input" type="text" id="authName" placeholder="Full name" style="display:none">
      <input class="auth-input" type="email" id="authEmail" placeholder="Email address" required>
      <input class="auth-input" type="password" id="authPassword" placeholder="Password" required minlength="6">
      <button class="btn-submit" type="submit" id="authSubmit">Sign In</button>
    </form>
    <div class="auth-toggle">
      <span id="authToggleText">Don't have an account?</span>
      <a id="authToggleLink" href="#" onclick="toggleAuthMode(); return false;"> Sign Up</a>
    </div>
  `;
  authMode = 'signin';
}

async function saveProfile(e) {
  e.preventDefault();
  const name = document.getElementById('profileName').value;
  try {
    await sb.from('profiles').update({ full_name: name }).eq('id', currentUser.id);
    userProfile = { ...userProfile, full_name: name };
    closeProfileEditor();
    updateAuthUI();
  } catch(err) {
    alert('Error saving profile: ' + err.message);
  }
}

// Check session on load
async function checkSession() {
  if (!sb) { updateAuthUI(); return; }
  try {
    const { data: { session } } = await sb.auth.getSession();
    if (session?.user) {
      currentUser = session.user;
      await loadProfile();
      await loadUserProgress();
    }
  } catch(e) {}
  updateAuthUI();
}

// ========== RENDER ==========
function renderModulePreviews() {
  const grid = document.getElementById('modulePreviewGrid');
  grid.innerHTML = courseData.map((mod, i) => `
    <div class="module-preview" onclick="startCourse(${i})">
      <div class="module-preview-num">${String(mod.id).padStart(2,'0')}</div>
      <div class="module-preview-label">Module ${mod.id}</div>
      <h3>${mod.title}</h3>
      <div class="theme">${mod.theme}</div>
      <div class="lessons-count">${mod.lessons.length} lessons ¬∑ ${mod.lessons.reduce((s,l) => s + parseInt(l.duration), 0)} min</div>
    </div>
  `).join('');
}

function renderSidebar() {
  const sidebar = document.getElementById('sidebar');
  const total = courseData.reduce((s, m) => s + m.lessons.length, 0);
  const pct = Math.round((completedLessons.size / total) * 100);

  let html = `
    <div class="overall-progress">
      <div class="overall-progress-label">
        <span>Course Progress</span>
        <strong>${completedLessons.size}/${total} lessons ¬∑ ${pct}%</strong>
      </div>
      <div class="progress-bar-track">
        <div class="progress-bar-fill" style="width:${pct}%"></div>
      </div>
    </div>
  `;

  courseData.forEach((mod, i) => {
    const isActive = i === currentModule;
    const allDone = mod.lessons.every(l => completedLessons.has(l.num));
    let cls = isActive ? 'active' : '';
    if (allDone) cls += ' completed';

    html += `
      <div class="module-nav-item">
        <button class="module-nav-btn ${cls}" onclick="switchModule(${i})">
          <span class="mod-num">${allDone ? '‚úì' : mod.id}</span>
          <span style="line-height:1.3">${mod.title}</span>
        </button>
        <div class="mod-dots">
          ${mod.lessons.map(l => {
            let dotCls = completedLessons.has(l.num) ? 'done' : '';
            if (!dotCls && i === currentModule) dotCls = 'current';
            return `<div class="mod-dot ${dotCls}"></div>`;
          }).join('')}
        </div>
      </div>
    `;
  });

  sidebar.innerHTML = html;
  document.getElementById('headerProgress').style.width = pct + '%';
  document.getElementById('progressPct').textContent = pct + '%';
}

function renderMainContent() {
  const mod = courseData[currentModule];
  const main = document.getElementById('mainContent');

  let html = `
    <div class="module-header fade-in">
      <div class="module-badge">‚ú¶ MODULE ${mod.id} OF 6</div>
      <h2>${mod.title}</h2>
      <div class="module-theme">"${mod.theme}"</div>
      <div style="margin-top:0.75rem;">
        <button onclick="resetModule(${mod.id})" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:0.4rem 0.9rem;color:var(--text-muted);font-size:0.75rem;font-family:'Sora',sans-serif;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--k-orange)';this.style.color='var(--k-orange)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='var(--text-muted)'">‚Ü∫ Reset Module</button>
      </div>
    </div>
  `;

  mod.lessons.forEach((lesson, i) => {
    const isDone = completedLessons.has(lesson.num);
    const cid = `lesson-${lesson.num}`;
    html += `
      <div class="lesson-card ${isDone ? 'done' : ''} fade-in" id="${cid}" style="animation-delay:${(i+1)*0.08}s">
        <div class="lesson-header" onclick="toggleLesson('${cid}')">
          <div class="lesson-num">${isDone ? '‚úì' : lesson.num}</div>
          <div class="lesson-info">
            <div class="lesson-title">${lesson.title}</div>
            <div class="lesson-meta">
              <span>${lesson.duration}</span><span>¬∑</span><span>${lesson.type}</span>
            </div>
          </div>
          <div class="lesson-toggle">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
          </div>
        </div>
        <div class="lesson-content">
          <div class="lesson-body">
            <!-- Video player area -->
            <div class="lesson-video-area" id="video-area-${lesson.num}"></div>

            <ul class="lesson-topics">
              ${lesson.topics.map(t => `<li>${t}</li>`).join('')}
            </ul>

            <!-- Notes from admin -->
            <div class="lesson-notes-area" id="notes-area-${lesson.num}"></div>

            <!-- Quiz area (must pass to complete) -->
            <div class="lesson-quiz-area" id="quiz-area-${lesson.num}"></div>

            <!-- Completion (hidden until quiz passed or no quiz) -->
            <div class="lesson-completion" id="completion-${lesson.num}" style="${isDone ? '' : 'display:none;'}">
              <div style="display:flex;align-items:center;justify-content:space-between;padding:0.75rem 1rem;background:rgba(74,222,128,0.08);border:1px solid rgba(74,222,128,0.2);border-radius:10px;margin-top:1rem;">
                <div style="display:flex;align-items:center;gap:0.5rem;">
                  <span style="color:#4ade80;font-size:1.1rem;">‚úì</span>
                  <span style="color:#4ade80;font-size:0.85rem;font-weight:600;">Lesson Complete!</span>
                </div>
                <button onclick="resetLesson(${lesson.num})" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:0.3rem 0.7rem;color:var(--text-muted);font-size:0.72rem;font-family:'Sora',sans-serif;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--k-orange)';this.style.color='var(--k-orange)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='var(--text-muted)'">‚Ü∫ Reset Lesson</button>
              </div>
            </div>

            <div class="lesson-actions" style="margin-top:1rem;">
              <button class="btn-lesson btn-primary" onclick="loadLessonContent(${lesson.num})">Start Lesson</button>
              <button class="btn-lesson btn-secondary" onclick="openNoteEditor(${lesson.num})">üìù Take Notes</button>
            </div>
          </div>
        </div>
      </div>
    `;
  });

  if (currentModule < courseData.length - 1) {
    const next = courseData[currentModule + 1];
    html += `
      <div class="next-module-card fade-in" style="animation-delay:0.4s">
        <p>Up next</p>
        <button class="btn-lesson btn-primary" onclick="switchModule(${currentModule + 1})" style="padding:0.75rem 2rem;font-size:0.88rem;">
          Module ${next.id}: ${next.title} ‚Üí
        </button>
      </div>
    `;
  } else {
    html += `
      <div class="next-module-card fade-in" style="animation-delay:0.4s">
        <p style="font-family:'DM Serif Display',serif; font-size:1.4rem; font-style:italic; color:var(--text-secondary); margin-bottom:0.4rem;">
          "Well done, good and faithful servant."
        </p>
        <p style="color:var(--k-orange); letter-spacing:0.06em; font-weight:500;">‚Äî Matthew 25:21</p>
      </div>
    `;
  }

  main.innerHTML = html;
}

// ========== INTERACTIONS ==========
function toggleLesson(cid) {
  const card = document.getElementById(cid);
  if (activeLessonCard && activeLessonCard !== card) activeLessonCard.classList.remove('active');
  card.classList.toggle('active');
  activeLessonCard = card.classList.contains('active') ? card : null;
}

function toggleComplete(num, checked) {
  if (checked) completedLessons.add(num);
  else completedLessons.delete(num);
  saveProgress();
  renderSidebar();
  const card = document.getElementById(`lesson-${num}`);
  if (card) {
    card.classList.toggle('done', checked);
    const n = card.querySelector('.lesson-num');
    if (n) n.textContent = checked ? '‚úì' : num;
  }
}

function resetLesson(num) {
  if (!confirm('Reset this lesson? Your quiz progress will be cleared and you can retake it.')) return;
  completedLessons.delete(num);
  quizPassed.delete(num);
  try { localStorage.setItem('kratos_quiz_passed', JSON.stringify([...quizPassed])); } catch(e) {}

  // Remove from Supabase
  if (sb && currentUser) {
    sb.from('user_progress').delete().eq('user_id', currentUser.id).eq('lesson_num', num).then(() => {});
  }

  saveProgress();
  renderSidebar();
  renderMainContent();
}

function resetModule(moduleId) {
  const mod = courseData.find(m => m.id === moduleId);
  if (!mod) return;
  const lessonNums = mod.lessons.map(l => l.num);
  const completedInModule = lessonNums.filter(n => completedLessons.has(n));

  if (completedInModule.length === 0) {
    alert('No completed lessons in this module to reset.');
    return;
  }

  if (!confirm(`Reset all ${completedInModule.length} completed lesson(s) in Module ${moduleId}: ${mod.title}?\n\nQuiz progress will also be cleared.`)) return;

  lessonNums.forEach(num => {
    completedLessons.delete(num);
    quizPassed.delete(num);
  });
  try { localStorage.setItem('kratos_quiz_passed', JSON.stringify([...quizPassed])); } catch(e) {}

  // Remove from Supabase
  if (sb && currentUser) {
    lessonNums.forEach(num => {
      sb.from('user_progress').delete().eq('user_id', currentUser.id).eq('lesson_num', num).then(() => {});
    });
  }

  saveProgress();
  renderSidebar();
  renderMainContent();
}

function switchModule(i) {
  currentModule = i;
  activeLessonCard = null;
  renderSidebar();
  renderMainContent();
  window.scrollTo({ top: 86, behavior: 'smooth' });
}

function showWelcome() {
  document.getElementById('welcomeView').classList.add('visible');
  document.getElementById('courseView').classList.remove('visible');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function startCourse(mi) {
  if (typeof mi === 'number') currentModule = mi;
  document.getElementById('welcomeView').classList.remove('visible');
  document.getElementById('courseView').classList.add('visible');
  renderSidebar();
  renderMainContent();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Header scroll
window.addEventListener('scroll', () => {
  document.getElementById('siteHeader').classList.toggle('scrolled', window.scrollY > 10);
});

// Close modal on overlay click
document.getElementById('authOverlay').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeAuth();
});

// ========== LESSON CONTENT (Video + Quiz + Notes) ==========
let lessonContentCache = {};
let quizAnswers = {};
let quizPassed = new Set();

// Load saved quiz passes
try {
  const savedQuiz = localStorage.getItem('kratos_quiz_passed');
  if (savedQuiz) quizPassed = new Set(JSON.parse(savedQuiz));
} catch(e) {}

async function loadLessonContent(lessonNum) {
  // Fetch from Supabase if not cached
  if (!lessonContentCache[lessonNum] && sb) {
    try {
      const { data } = await sb.from('lesson_content')
        .select('*')
        .eq('lesson_num', lessonNum)
        .single();
      if (data) lessonContentCache[lessonNum] = data;
    } catch(e) {}
  }

  const content = lessonContentCache[lessonNum];
  const videoArea = document.getElementById('video-area-' + lessonNum);
  const notesArea = document.getElementById('notes-area-' + lessonNum);
  const quizArea = document.getElementById('quiz-area-' + lessonNum);
  const completionArea = document.getElementById('completion-' + lessonNum);

  // Render video
  if (content?.video_url) {
    videoArea.innerHTML = `
      <div class="lesson-video">
        <video controls preload="metadata">
          <source src="${content.video_url}" type="video/mp4">
          Your browser does not support video playback.
        </video>
      </div>`;
  }

  // Render admin notes
  if (content?.generated_notes) {
    notesArea.innerHTML = `
      <div class="admin-notes">
        <h4>üìñ Lesson Notes</h4>
        ${content.generated_notes.split('\n').map(line => {
          if (line.startsWith('# ')) return `<h3 style="font-size:1rem;margin:0.75rem 0 0.25rem;color:var(--text-primary)">${line.slice(2)}</h3>`;
          if (line.startsWith('## ')) return `<h4 style="font-size:0.9rem;margin:0.6rem 0 0.2rem;color:var(--text-primary)">${line.slice(3)}</h4>`;
          if (line.startsWith('- ')) return `<div style="padding-left:1rem;position:relative"><span style="position:absolute;left:0;color:var(--k-cyan)">‚Ä¢</span>${line.slice(2)}</div>`;
          if (line.trim()) return `<p style="margin:0.3rem 0">${line}</p>`;
          return '';
        }).join('')}
      </div>`;
  }

  // Render quiz
  const isDone = completedLessons.has(lessonNum);
  const isPassed = quizPassed.has(lessonNum) || isDone;

  if (content?.generated_quiz && Array.isArray(content.generated_quiz) && content.generated_quiz.length > 0) {
    if (isPassed) {
      quizArea.innerHTML = `
        <div class="quiz-result pass" style="margin-top:1rem;">
          ‚úÖ Quiz passed! Lesson complete.
        </div>`;
      completionArea.style.display = 'block';
    } else {
      quizAnswers[lessonNum] = {};
      let qHtml = `<div class="quiz-container"><h4>üìù Lesson Quiz</h4><p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:1rem;">Answer all questions correctly to complete this lesson.</p>`;

      content.generated_quiz.forEach((q, qi) => {
        qHtml += `<div class="quiz-q" id="quiz-${lessonNum}-q${qi}">
          <div class="quiz-q-num">Question ${qi + 1}</div>
          <div class="quiz-q-text">${q.question}</div>`;
        q.options.forEach((opt, oi) => {
          qHtml += `<div class="quiz-opt" id="quiz-${lessonNum}-q${qi}-o${oi}" onclick="selectQuizAnswer(${lessonNum}, ${qi}, ${oi})">
            <div class="quiz-radio"></div>
            <span>${opt}</span>
          </div>`;
        });
        qHtml += `</div>`;
      });

      qHtml += `<button class="btn-lesson btn-primary quiz-btn" onclick="submitQuiz(${lessonNum})">Submit Answers</button>`;
      qHtml += `<div id="quiz-result-${lessonNum}"></div></div>`;
      quizArea.innerHTML = qHtml;
      completionArea.style.display = 'none';
    }
  } else {
    // No quiz ‚Äî show completion checkbox
    if (!isDone) {
      quizArea.innerHTML = `
        <label class="completion-check" onclick="event.stopPropagation()" style="margin-top:1rem;">
          <input type="checkbox" onchange="toggleComplete(${lessonNum}, this.checked)">
          <span class="check-box"></span>
          <span>Mark as completed</span>
        </label>`;
    }
    if (isDone) completionArea.style.display = 'block';
  }
}

function selectQuizAnswer(lessonNum, qIdx, optIdx) {
  // Clear previous selection for this question
  const quiz = lessonContentCache[lessonNum]?.generated_quiz;
  if (!quiz) return;

  quiz[qIdx].options.forEach((_, oi) => {
    const el = document.getElementById(`quiz-${lessonNum}-q${qIdx}-o${oi}`);
    if (el) el.classList.remove('selected', 'correct', 'wrong');
  });

  // Select new
  const selected = document.getElementById(`quiz-${lessonNum}-q${qIdx}-o${optIdx}`);
  if (selected) selected.classList.add('selected');

  if (!quizAnswers[lessonNum]) quizAnswers[lessonNum] = {};
  quizAnswers[lessonNum][qIdx] = optIdx;
}

function submitQuiz(lessonNum) {
  const quiz = lessonContentCache[lessonNum]?.generated_quiz;
  if (!quiz) return;

  const answers = quizAnswers[lessonNum] || {};
  let correct = 0;
  let total = quiz.length;

  // Check if all questions answered
  if (Object.keys(answers).length < total) {
    document.getElementById(`quiz-result-${lessonNum}`).innerHTML = `
      <div class="quiz-result fail">Please answer all questions before submitting.</div>`;
    return;
  }

  // Grade
  quiz.forEach((q, qi) => {
    const userAnswer = answers[qi];
    const correctAnswer = q.answer;
    const isCorrect = userAnswer === correctAnswer;

    if (isCorrect) correct++;

    // Show correct/wrong
    q.options.forEach((_, oi) => {
      const el = document.getElementById(`quiz-${lessonNum}-q${qi}-o${oi}`);
      if (!el) return;
      el.classList.remove('selected');
      if (oi === correctAnswer) el.classList.add('correct');
      else if (oi === userAnswer && !isCorrect) el.classList.add('wrong');
    });
  });

  const passed = correct === total;
  const resultEl = document.getElementById(`quiz-result-${lessonNum}`);

  if (passed) {
    quizPassed.add(lessonNum);
    try { localStorage.setItem('kratos_quiz_passed', JSON.stringify([...quizPassed])); } catch(e) {}

    resultEl.innerHTML = `
      <div class="quiz-result pass">
        üéâ ${correct}/${total} correct ‚Äî Quiz Passed! Lesson marked as complete.
      </div>`;

    // Auto-complete the lesson
    toggleComplete(lessonNum, true);
    document.getElementById('completion-' + lessonNum).style.display = 'block';
  } else {
    resultEl.innerHTML = `
      <div class="quiz-result fail">
        ${correct}/${total} correct ‚Äî You need a perfect score to pass. 
        <button class="btn-lesson btn-secondary" style="margin-top:0.5rem;display:block;margin-left:auto;margin-right:auto;" onclick="retryQuiz(${lessonNum})">Try Again</button>
      </div>`;
  }
}

function retryQuiz(lessonNum) {
  quizAnswers[lessonNum] = {};
  loadLessonContent(lessonNum);
}

// ========== NOTE EDITOR ==========
function openNoteEditor(lessonNum) {
  // Create modal if not exists
  let modal = document.getElementById('noteModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'noteModal';
    modal.className = 'note-modal';
    document.body.appendChild(modal);
  }

  const lessonTitle = courseData.flatMap(m => m.lessons).find(l => l.num === lessonNum)?.title || 'Lesson ' + lessonNum;

  // Load existing note
  let existingNote = '';
  if (sb && currentUser) {
    sb.from('user_notes').select('content').eq('user_id', currentUser.id).eq('lesson_num', lessonNum).single()
      .then(({ data }) => {
        if (data?.content) {
          document.getElementById('noteTextarea').value = data.content;
        }
      });
  }

  modal.innerHTML = `
    <div class="note-modal-box">
      <h3>üìù Notes: ${lessonTitle}</h3>
      <textarea id="noteTextarea" placeholder="Write your notes here...">${existingNote}</textarea>
      <div style="display:flex;gap:0.5rem;margin-top:1rem;">
        <button class="btn-lesson btn-primary" onclick="saveNoteFromModal(${lessonNum})">Save Notes</button>
        <button class="btn-lesson btn-secondary" onclick="closeNoteModal()">Cancel</button>
      </div>
    </div>`;
  modal.classList.add('visible');
}

async function saveNoteFromModal(lessonNum) {
  const content = document.getElementById('noteTextarea').value;
  if (sb && currentUser) {
    await sb.from('user_notes').upsert({
      user_id: currentUser.id,
      lesson_num: lessonNum,
      content: content,
      updated_at: new Date().toISOString()
    }, { onConflict: 'user_id,lesson_num' });
  }
  closeNoteModal();
}

function closeNoteModal() {
  const modal = document.getElementById('noteModal');
  if (modal) modal.classList.remove('visible');
}

// ========== INIT ==========
renderModulePreviews();
checkSession();
</script>
</body>
</html>